# Mamba-Based Bird Classification from VGGish Audio Features

## Overview
This project uses a Mamba-based deep learning model to classify bird species from audio features generated by VGGish. The dataset consists of `.npy` files containing spectrogram-derived embeddings and species labels.

## Installation
Make sure Python is installed, then run the following commands:

```
pip install causal-conv1d>=1.2.0
pip install mamba-ssm
```

## Data Preparation
Place your `.npy` files in the `../npy/` directory. The data should include VGGish embeddings and associated labels. Data is split into training, validation, and test sets in an 80-10-10 ratio.

## Usage
We used gogle colab for the project

### Mount Google Drive (for Google Colab users)
```python
from google.colab import drive
drive.mount('/content/drive/')
%cd /content/drive/MyDrive/dl_project_data/sscape-avian-div-generalisability/
import sys
sys.path.append('/content/drive/MyDrive/dl_project_data/sscape-avian-div-generalisability')
```

### Dataset Processing
```python
from torch.utils.data import Dataset
import numpy as np
import torch

class VGGishRegionDataset(Dataset):
    def __init__(self, all_datasets):
        self.data = []
        for dataset in all_datasets:
            all_vggish_pcs = np.load(f"../npy/{dataset}.npy", allow_pickle=True)
            for pc in all_vggish_pcs:
                if len(pc.avi_spec_comm) > 0:
                    self.data.append((
                        pc.id,
                        pc.audio_feats,
                        encode_birds(pc.avi_spec_comm, bird_to_index, len(avi_set))
                    ))

    def __len__(self):
        return len(self.data)

    def __getitem__(self, idx):
        pc_id, audio_feats, avi_spec_comm = self.data[idx]
        return (
            torch.tensor(audio_feats, dtype=torch.float32),
            torch.tensor(avi_spec_comm, dtype=torch.float32),
            pc_id
        )
```

### Training Data Preparation
```python
from torch.utils.data import DataLoader, random_split
import torch
import numpy as np

torch.manual_seed(42)
np.random.seed(42)

dataset = VGGishRegionDataset(npy_files)
train_size = int(0.8 * len(dataset))
valid_size = int(0.1 * len(dataset))
test_size = len(dataset) - train_size - valid_size

train_dataset, valid_dataset, test_dataset = random_split(
    dataset, [train_size, valid_size, test_size]
)
```

## Model Architecture
```python
import torch.nn as nn
from mamba_ssm import Mamba

class MambaBirdClassifier(nn.Module):
    def __init__(self, input_dim=128, hidden_dim=256, n_mamba_layers=3, n_classes=200, dropout=0.3):
        super().__init__()
        self.input_projection = nn.Sequential(
            nn.Linear(input_dim, hidden_dim),
            nn.LayerNorm(hidden_dim),
            nn.GELU()
        )
        self.mamba_layers = nn.ModuleList([
            Mamba(d_model=hidden_dim, d_state=256, d_conv=4, expand=2)
            for _ in range(n_mamba_layers)
        ])
        self.ln_f = nn.LayerNorm(hidden_dim)
        self.pool = nn.AdaptiveAvgPool1d(1)
        self.classifier = nn.Linear(hidden_dim, n_classes)

    def forward(self, x):
        x = self.input_projection(x)
        for layer in self.mamba_layers:
            x = layer(x)
        x = self.ln_f(x)
        x = self.pool(x.transpose(1, 2)).squeeze(-1)
        return self.classifier(x)
```

## Model Evaluation
```python
def test_results(path_name, test_dataset, test_name):
    device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
    model = MambaBirdClassifier(n_classes=len(avi_set)).to(device)
    model.load_state_dict(torch.load(path_name))
    model.eval()

    results = {"actual birds": [], "predicted birds": []}
    for audio_feats, avi_spec_comm, _ in test_dataset:
        audio_feats = audio_feats.to(device)
        logits = model(audio_feats.unsqueeze(0))
        predictions = (logits.sigmoid() > 0.5).cpu().numpy()
        results["predicted birds"].append(predictions)
        results["actual birds"].append(avi_spec_comm.numpy())

    results_to_text(results, test_name)
```

## `DL_project_test.py`
This script allows testing the trained model using saved weights, without retraining.

Make sure pre-trained weights are in the `models/` directory.

To run:
```
python DL_project_test.py
```

## Loading Model Weights
```python
import torch
from model import MambaBirdClassifier

model = MambaBirdClassifier(n_classes=200)
model.load_state_dict(torch.load("models/best_model.pth"))
model.eval()
```

## Results and Analysis
- **RÂ² score** for accuracy
- **Precision-recall analysis**
- **Mean correct predictions**
- **False positive/negative analysis**
